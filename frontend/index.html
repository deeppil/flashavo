<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVO</title>
</head>
<body>
    <h1>AVOflash: topics -> cards in seconds</h1>
    <input type="text" placeholder="Topic" id="topic"><br><br>
    <input type="number" id="number"><br><br>
    <button id="gen">GENERATE</button>
    <p id="echo"></p>
    <div id="cards"></div>

    <script>
        document.getElementById("gen").onclick = () => {
            const t = document.getElementById("topic").value.trim();
            const n = document.getElementById("number").value;
            const number = parseInt(n, 10);
            const count = Number.isFinite(number) && number > 0 ? number : 3;
            const payload = {topics: t, number: count};
            if (!t) { document.getElementById("echo").textContent = "Enter a topic."; return;}

            document.getElementById("echo").textContent = "Generatingâ€¦";

            fetch("http://127.0.0.1:5000/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json"},
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(({cards}) => {
                document.getElementById("echo").textContent = `Generated ${cards.length} cards.`;
                const root = document.getElementById("cards");
                root.innerHTML = "";
                cards.forEach(c => {
                    let check = 0;
                    const card = document.createElement("div");
                    card.style.border = "1px solid #ccc";
                    card.style.borderRadius = "8px";
                    card.style.padding = "12px";
                    card.style.margin = "8px 0";
                    card.style.cursor = "pointer";
                    card.style.userSelect = "none";
                    const front = document.createElement("div");
                    front.innerHTML = `<strong>Q:</strong> ${c.front}`;

                    const flip = document.createElement("button");
                    flip.textContent = "Flip";
                
                    const back = document.createElement("div");
                    back.innerHTML = `<strong>A:</strong> ${c.back}`;
                    back.style.marginTop = "8px";
                    back.style.display = "none";

                    flip.onclick = () => {
                        if (check == 0) {
                            front.innerHTML = `<strong>A:</strong> ${c.back}`;
                            check = 1;
                        } else if(check == 1) {
                            front.innerHTML = `<strong>Q:</strong> ${c.front}`;
                            check = 0;
                        }
                    };

                    // follow-up btn
                    const follow_up_btn = document.createElement("button");
                    const follow_up_answer = document.createElement("p");
                    follow_up_answer.textContent = "";
                    const enter_btn = document.createElement("button");
                    enter_btn.textContent = "Enter"
                    
                    follow_up_btn.textContent = "Follow-up";
                    follow_up_btn.style.marginTop = "8px";

                    const follow_up = document.createElement("div");
                    const follow_input = document.createElement("input");
                    follow_input.placeholder = "Type follow-up";
    
                    follow_up.style.marginTop = "8px";
                    follow_up.style.display = "none";
                    follow_up_btn.onclick = async (e) => {
                        follow_up.style.display = follow_up.style.display === "none" ? "block" : "none";
                    }

                    enter_btn.onclick = () => {
                        const query = follow_input.value.trim();
                        
                        const follow_payload = {
                            query: query,
                            question: c.front,
                            topic: t,
                            answer: c.back
                        };

                        if (!query) return; 
                        follow_payload.question = c.front;
                        follow_payload.query = query;
                        follow_payload.topic = t;
                        follow_payload.answer = c.back;

                        fetch("http://127.0.0.1:5000/follow", {
                            method: "POST",
                            headers: { "Content-Type": "application/json"},
                            body: JSON.stringify(follow_payload)
                        })
                        .then(res => {
                            if (!res.ok) throw new Error(`HTTP ${res.status}`);
                            return res.json();
                        })
                        .then((answer) => {
                            console.log(answer.answer);
                            follow_up_answer.textContent = answer.answer;
                        })
                    }

                    follow_up.appendChild(follow_input);
                    follow_up.appendChild(enter_btn);

                    card.appendChild(front);
                    card.appendChild(back);
                    card.appendChild(flip);
                    card.appendChild(follow_up_btn)
                    card.appendChild(follow_up)
                    card.appendChild(follow_up_answer)
                    root.appendChild(card);

                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById("cards").textContent = "Error: " + err.message;
            });
        };
    </script>
</body>
</html>